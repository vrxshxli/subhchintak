generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  phone        String?
  passwordHash String?
  googleId     String?  @unique
  avatarUrl    String?
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  qrCodes           QRCode[]
  emergencyContacts EmergencyContact[]
  orders            Order[]
  chatSessionsOwner ChatSession[]      @relation("OwnerSessions")
  callLogs          CallLog[]
  notifications     Notification[]

  @@map("users")
}

enum QRStatus {
  INACTIVE
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum QRPurpose {
  FOUR_WHEELER
  TWO_WHEELER
  BAG
  KEY
  CHILD
  ELDERLY
  PET
  CUSTOM
}

model QRCode {
  id            String    @id @default(uuid())
  userId        String
  uniqueCode    String    @unique @default(uuid())
  purpose       QRPurpose @default(CUSTOM)
  customPurpose String?
  templateType  String?
  status        QRStatus  @default(INACTIVE)
  qrImageUrl    String?
  customization Json?
  scansCount    Int       @default(0)
  activatedAt   DateTime?
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  scanLogs     ScanLog[]
  chatSessions ChatSession[]
  callLogs     CallLog[]
  orders       Order[]

  @@index([userId])
  @@index([uniqueCode])
  @@map("qr_codes")
}

model ScanLog {
  id        String   @id @default(uuid())
  qrCodeId  String
  scannerIp String?
  userAgent String?
  latitude  Float?
  longitude Float?
  city      String?
  country   String?
  scannedAt DateTime @default(now())

  qrCode QRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@index([qrCodeId])
  @@map("scan_logs")
}

model EmergencyContact {
  id        String   @id @default(uuid())
  userId    String
  name      String
  phone     String
  relation  String?
  priority  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("emergency_contacts")
}

model ChatSession {
  id            String   @id @default(uuid())
  qrCodeId      String
  ownerId       String
  strangerToken String   @unique @default(uuid())
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  qrCode   QRCode        @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  owner    User          @relation("OwnerSessions", fields: [ownerId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([ownerId])
  @@index([qrCodeId])
  @@map("chat_sessions")
}

enum MessageType {
  TEXT
  VOICE
  LOCATION
  SYSTEM
}

model ChatMessage {
  id          String      @id @default(uuid())
  sessionId   String
  senderType  String
  messageType MessageType @default(TEXT)
  content     String
  mediaUrl    String?
  latitude    Float?
  longitude   Float?
  isRead      Boolean     @default(false)
  createdAt   DateTime    @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

enum CallStatus {
  INITIATED
  RINGING
  ANSWERED
  MISSED
  ESCALATED
  COMPLETED
}

model CallLog {
  id                 String     @id @default(uuid())
  qrCodeId           String
  ownerId            String
  status             CallStatus @default(INITIATED)
  duration           Int?
  escalatedToContact String?
  escalationLevel    Int        @default(0)
  startedAt          DateTime   @default(now())
  endedAt            DateTime?

  qrCode QRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  owner  User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([qrCodeId])
  @@map("call_logs")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderType {
  PDF_DOWNLOAD
  PHYSICAL_STICKER
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  qrCodeId        String?
  orderType       OrderType
  status          OrderStatus @default(PENDING)
  amount          Float
  currency        String      @default("INR")
  paymentId       String?
  paymentGateway  String?
  shippingAddress Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  qrCode QRCode? @relation(fields: [qrCodeId], references: [id])

  @@index([userId])
  @@map("orders")
}

enum NotificationType {
  QR_SCANNED
  CALL_RECEIVED
  CALL_MISSED
  EMERGENCY_ESCALATION
  CHAT_MESSAGE
  PAYMENT_SUCCESS
  SYSTEM_UPDATE
  OFFER
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}
