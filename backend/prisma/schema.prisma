generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  phone         String?
  passwordHash  String?
  googleId      String?  @unique
  avatarUrl     String?
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  qrCodes           QRCode[]
  tagDesigns        TagDesign[]
  emergencyContacts EmergencyContact[]
  orders            Order[]
  stickerOrders     StickerOrder[]
  addresses         Address[]
  chatSessionsOwner ChatSession[]      @relation("OwnerSessions")
  callLogs          CallLog[]
  notifications     Notification[]

  @@map("users")
}

enum QRStatus {
  INACTIVE
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum QRPurpose {
  FOUR_WHEELER
  TWO_WHEELER
  BAG
  KEY
  CHILD
  ELDERLY
  PET
  CUSTOM
}

model QRCode {
  id             String    @id @default(uuid())
  userId         String
  uniqueCode     String    @unique @default(uuid())
  purpose        QRPurpose @default(CUSTOM)
  customPurpose  String?
  templateType   String?
  status         QRStatus  @default(INACTIVE)
  qrImageUrl     String?
  customization  Json?
  scansCount     Int       @default(0)
  activatedAt    DateTime?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tagDesigns   TagDesign[]
  scanLogs     ScanLog[]
  chatSessions ChatSession[]
  callLogs     CallLog[]
  orders       Order[]

  @@index([userId])
  @@index([uniqueCode])
  @@map("qr_codes")
}

model TagDesign {
  id             String    @id @default(uuid())
  userId         String
  qrCodeId       String
  purpose        QRPurpose @default(CUSTOM)
  customPurpose  String?
  templateType   String?
  customization  Json?
  thumbnailUrl   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  qrCode        QRCode             @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  stickerItems  StickerOrderItem[]

  @@index([userId])
  @@index([qrCodeId])
  @@map("tag_designs")
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  fullName     String
  phone        String
  pincode      String
  city         String
  state        String
  addressLine1 String
  addressLine2 String?
  landmark     String?
  isDefault    Boolean  @default(false)
  latitude     Float?
  longitude    Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  stickerOrders StickerOrder[]

  @@index([userId])
  @@map("addresses")
}

enum StickerOrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model StickerOrder {
  id              String             @id @default(uuid())
  userId          String
  addressId       String
  status          StickerOrderStatus @default(PENDING)
  subtotal        Float
  shippingCharge  Float              @default(49)
  totalAmount     Float
  paymentId       String?
  paymentGateway  String?
  trackingId      String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  address Address            @relation(fields: [addressId], references: [id])
  items   StickerOrderItem[]

  @@index([userId])
  @@map("sticker_orders")
}

model StickerOrderItem {
  id              String @id @default(uuid())
  stickerOrderId  String
  tagDesignId     String
  quantity        Int    @default(1)
  pricePerUnit    Float  @default(99)

  stickerOrder StickerOrder @relation(fields: [stickerOrderId], references: [id], onDelete: Cascade)
  tagDesign    TagDesign    @relation(fields: [tagDesignId], references: [id])

  @@map("sticker_order_items")
}

model ScanLog {
  id          String   @id @default(uuid())
  qrCodeId    String
  scannerIp   String?
  userAgent   String?
  latitude    Float?
  longitude   Float?
  city        String?
  country     String?
  scannedAt   DateTime @default(now())

  qrCode QRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@index([qrCodeId])
  @@map("scan_logs")
}

model EmergencyContact {
  id        String   @id @default(uuid())
  userId    String
  name      String
  phone     String
  relation  String?
  priority  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("emergency_contacts")
}

model ChatSession {
  id            String   @id @default(uuid())
  qrCodeId      String
  ownerId       String
  strangerToken String   @unique @default(uuid())
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  qrCode   QRCode        @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  owner    User          @relation("OwnerSessions", fields: [ownerId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([ownerId])
  @@index([qrCodeId])
  @@map("chat_sessions")
}

enum MessageType {
  TEXT
  VOICE
  LOCATION
  SYSTEM
}

model ChatMessage {
  id          String      @id @default(uuid())
  sessionId   String
  senderType  String
  messageType MessageType @default(TEXT)
  content     String
  mediaUrl    String?
  latitude    Float?
  longitude   Float?
  isRead      Boolean     @default(false)
  createdAt   DateTime    @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

enum CallStatus {
  INITIATED
  RINGING
  ANSWERED
  MISSED
  ESCALATED
  COMPLETED
}

model CallLog {
  id                 String     @id @default(uuid())
  qrCodeId           String
  ownerId            String
  status             CallStatus @default(INITIATED)
  duration           Int?
  escalatedToContact String?
  escalationLevel    Int        @default(0)
  startedAt          DateTime   @default(now())
  endedAt            DateTime?

  qrCode QRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  owner  User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([qrCodeId])
  @@map("call_logs")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderType {
  PDF_DOWNLOAD
  PHYSICAL_STICKER
  YEARLY_SUBSCRIPTION
}

model Order {
  id             String      @id @default(uuid())
  userId         String
  qrCodeId       String?
  orderType      OrderType
  status         OrderStatus @default(PENDING)
  amount         Float
  currency       String      @default("INR")
  paymentId      String?
  paymentGateway String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  qrCode QRCode? @relation(fields: [qrCodeId], references: [id])

  @@index([userId])
  @@map("orders")
}

enum NotificationType {
  QR_SCANNED
  CALL_RECEIVED
  CALL_MISSED
  EMERGENCY_ESCALATION
  CHAT_MESSAGE
  PAYMENT_SUCCESS
  SYSTEM_UPDATE
  OFFER
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}
